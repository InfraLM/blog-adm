const express = require('express');
const session = require('express-session');
const cors = require('cors');
const helmet = require('helmet');
const compression = require('compression');
const rateLimit = require('express-rate-limit');
const path = require('path');
const { Client } = require('pg');
const AWS = require('aws-sdk');
const multer = require('multer');
const crypto = require('crypto');

console.log('========================================');
console.log(' BLOG ADMINISTRA√á√ÉO WEB - SIMPLES');
console.log(' Conex√£o Direta PostgreSQL (SEM SSL)');
console.log('========================================');
console.log();

// Carregar vari√°veis de ambiente
require('dotenv').config();

// Configura√ß√£o do servidor
const app = express();
const PORT = process.env.PORT || 3000;

// CONFIGURA√á√ÉO POSTGRESQL SIMPLES (SEM SSL)
const dbConfig = {
  host: '35.199.101.38',
  port: 5432,
  database: 'liberdade-medica',
  user: 'vinilean',
  password: '-Infra55LM-',
  ssl: false, // SSL EXPLICITAMENTE DESABILITADO
  connectionTimeoutMillis: 30000, // 30 segundos
  query_timeout: 60000, // 60 segundos
  statement_timeout: 60000, // 60 segundos
  idle_in_transaction_session_timeout: 60000 // 60 segundos
};

// Configura√ß√£o do Backblaze B2
const b2Config = {
  accessKeyId: process.env.B2_ACCESS_KEY_ID || '005130cedd268650000000004',
  secretAccessKey: process.env.B2_SECRET_ACCESS_KEY || 'K005h8RBjbhsVX5NieckVPQ0ZKGHSAc',
  endpoint: process.env.B2_ENDPOINT || 'https://s3.us-east-005.backblazeb2.com',
  region: process.env.B2_REGION || 'us-east-005',
  bucket: process.env.B2_BUCKET || 'imagensblog'
};

// Configurar AWS SDK para Backblaze B2
const s3 = new AWS.S3({
  accessKeyId: b2Config.accessKeyId,
  secretAccessKey: b2Config.secretAccessKey,
  endpoint: b2Config.endpoint,
  region: b2Config.region,
  s3ForcePathStyle: true
});

// Configurar multer para upload de arquivos
const upload = multer({
  storage: multer.memoryStorage(),
  limits: {
    fileSize: 10 * 1024 * 1024 // 10MB
  },
  fileFilter: (req, file, cb) => {
    if (file.mimetype.startsWith('image/')) {
      cb(null, true);
    } else {
      cb(new Error('Apenas arquivos de imagem s√£o permitidos'), false);
    }
  }
});

// Credenciais de acesso
const ADMIN_CREDENTIALS = {
  username: process.env.ADMIN_USERNAME || 'admbolado',
  password: process.env.ADMIN_PASSWORD || 'lmbolado'
};

// Cliente PostgreSQL
let pgClient = null;
let dbConnected = false;

// Middlewares de seguran√ßa
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:", "*.backblazeb2.com"],
      connectSrc: ["'self'"],
      fontSrc: ["'self'"],
      objectSrc: ["'none'"],
      mediaSrc: ["'self'"],
      frameSrc: ["'none'"],
    },
  },
}));

app.use(compression());

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100,
  message: 'Muitas tentativas. Tente novamente em 15 minutos.'
});

const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  message: 'Muitas tentativas de login. Tente novamente em 15 minutos.'
});

app.use('/blog-adm/api/login', loginLimiter);
app.use('/blog-adm/api/', limiter);

// Configura√ß√£o de sess√£o
app.use(session({
  secret: process.env.SESSION_SECRET || 'liberdade-medica-blog-admin-2025',
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production',
    httpOnly: true,
    maxAge: 24 * 60 * 60 * 1000
  }
}));

app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

app.use(cors({
  origin: true,
  credentials: true
}));

// Servir arquivos est√°ticos
app.use('/blog-adm', express.static(path.join(__dirname, '../public/blog-adm')));

// Middleware de autentica√ß√£o
function requireAuth(req, res, next) {
  if (req.session && req.session.authenticated) {
    return next();
  } else {
    return res.status(401).json({
      success: false,
      message: 'Acesso negado. Fa√ßa login primeiro.'
    });
  }
}

// FUN√á√ÉO SIMPLES PARA CONECTAR POSTGRESQL
async function connectPostgreSQL() {
  console.log('üîÑ Conectando ao PostgreSQL...');
  console.log('üìç Host:', dbConfig.host + ':' + dbConfig.port);
  console.log('üìä Database:', dbConfig.database);
  console.log('üë§ User:', dbConfig.user);
  console.log('üîê SSL:', dbConfig.ssl ? 'HABILITADO' : 'DESABILITADO');
  console.log('‚è±Ô∏è Timeout:', dbConfig.connectionTimeoutMillis + 'ms');
  console.log();

  try {
    pgClient = new Client(dbConfig);
    
    console.log('üîÑ Estabelecendo conex√£o...');
    await pgClient.connect();
    
    console.log('‚úÖ Conex√£o estabelecida!');
    
    // Testar query b√°sica
    const result = await pgClient.query('SELECT version()');
    console.log('üìä PostgreSQL Version:', result.rows[0].version.split(' ')[0], result.rows[0].version.split(' ')[1]);
    
    // Verificar tabela
    const tableCheck = await pgClient.query(`
      SELECT COUNT(*) as count 
      FROM information_schema.tables 
      WHERE table_schema = 'public' 
      AND table_name = 'blog_artigos'
    `);
    
    if (tableCheck.rows[0].count > 0) {
      console.log('‚úÖ Tabela blog_artigos encontrada');
      
      const countResult = await pgClient.query('SELECT COUNT(*) as total FROM public.blog_artigos');
      console.log('üìÑ Artigos existentes:', countResult.rows[0].total);
      
      dbConnected = true;
      
      console.log();
      console.log('üéâ POSTGRESQL CONECTADO COM SUCESSO!');
      console.log('üìç Endpoint:', dbConfig.host + ':' + dbConfig.port);
      console.log('üîê SSL: DESABILITADO (conforme solicitado)');
      console.log();
      
      return true;
    } else {
      console.log('‚ö†Ô∏è Tabela blog_artigos n√£o encontrada');
      throw new Error('Tabela n√£o encontrada');
    }
    
  } catch (error) {
    console.log('‚ùå ERRO NA CONEX√ÉO POSTGRESQL:', error.message);
    console.log();
    console.log('üí° POSS√çVEIS SOLU√á√ïES:');
    console.log('1. Verificar se o servidor PostgreSQL est√° rodando');
    console.log('2. Verificar firewall/rede corporativa');
    console.log('3. Tentar t√∫nel SSH:');
    console.log('   ssh -L 5433:localhost:5432 vinilean@35.199.101.38');
    console.log('4. Verificar credenciais');
    console.log();
    
    pgClient = null;
    dbConnected = false;
    return false;
  }
}

// Fun√ß√£o para fazer upload de imagem para Backblaze B2
async function uploadImageToB2(file, filename) {
  try {
    const fileExtension = path.extname(file.originalname);
    const uniqueFilename = filename || `${crypto.randomUUID()}${fileExtension}`;
    
    const uploadParams = {
      Bucket: b2Config.bucket,
      Key: uniqueFilename,
      Body: file.buffer,
      ContentType: file.mimetype,
      ACL: 'public-read'
    };

    console.log('üîÑ Upload para Backblaze B2:', uniqueFilename);
    
    const result = await s3.upload(uploadParams).promise();
    
    const publicUrl = `https://${b2Config.bucket}.s3.us-east-005.backblazeb2.com/${uniqueFilename}`;
    
    console.log('‚úÖ Upload conclu√≠do:', publicUrl);
    
    return {
      success: true,
      url: publicUrl,
      key: uniqueFilename,
      size: file.size,
      mimetype: file.mimetype
    };
  } catch (error) {
    console.error('‚ùå Erro no upload para B2:', error);
    throw error;
  }
}

// Rotas de autentica√ß√£o
app.post('/blog-adm/api/login', async (req, res) => {
  try {
    const { username, password } = req.body;
    
    console.log('üîê Login:', { username, timestamp: new Date().toISOString() });
    
    if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
      req.session.authenticated = true;
      req.session.username = username;
      
      console.log('‚úÖ Login bem-sucedido:', username);
      
      res.json({
        success: true,
        message: 'Login realizado com sucesso!',
        user: { username },
        database: dbConnected ? 'PostgreSQL Conectado (SSL Desabilitado)' : 'PostgreSQL Desconectado'
      });
    } else {
      console.log('‚ùå Credenciais inv√°lidas:', username);
      
      res.status(401).json({
        success: false,
        message: 'Credenciais inv√°lidas'
      });
    }
  } catch (error) {
    console.error('‚ùå Erro no login:', error);
    res.status(500).json({
      success: false,
      message: 'Erro interno do servidor'
    });
  }
});

app.post('/blog-adm/api/logout', (req, res) => {
  req.session.destroy((err) => {
    if (err) {
      console.error('‚ùå Erro ao fazer logout:', err);
      return res.status(500).json({
        success: false,
        message: 'Erro ao fazer logout'
      });
    }
    
    console.log('‚úÖ Logout realizado');
    res.json({
      success: true,
      message: 'Logout realizado com sucesso'
    });
  });
});

app.get('/blog-adm/api/auth-status', (req, res) => {
  res.json({
    authenticated: !!(req.session && req.session.authenticated),
    username: req.session ? req.session.username : null,
    database: dbConnected ? 'connected' : 'disconnected',
    ssl: 'disabled'
  });
});

// Rotas da API (protegidas)
app.get('/blog-adm/api/health', requireAuth, (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    postgresql: dbConnected ? 'connected' : 'disconnected',
    ssl: 'disabled',
    session: req.session.username
  });
});

app.get('/blog-adm/api/test-connection', requireAuth, async (req, res) => {
  try {
    if (!pgClient || !dbConnected) {
      return res.json({
        success: false,
        message: '‚ùå PostgreSQL desconectado - Reinicie o servidor',
        mode: 'disconnected',
        ssl: 'disabled'
      });
    }

    await pgClient.query('SELECT 1');
    
    res.json({
      success: true,
      message: '‚úÖ PostgreSQL conectado (SSL desabilitado)',
      mode: 'postgresql',
      status: 'connected',
      ssl: 'disabled',
      endpoint: `${dbConfig.host}:${dbConfig.port}`,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('‚ùå Erro no teste de conex√£o:', error);
    res.status(500).json({
      success: false,
      message: 'Erro na conex√£o: ' + error.message,
      mode: 'error'
    });
  }
});

// Upload de imagem
app.post('/blog-adm/api/upload-image', requireAuth, upload.single('image'), async (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({
        success: false,
        message: 'Nenhuma imagem foi enviada'
      });
    }

    console.log('üì∑ Upload de imagem:', {
      originalname: req.file.originalname,
      mimetype: req.file.mimetype,
      size: req.file.size,
      user: req.session.username
    });

    const uploadResult = await uploadImageToB2(req.file);

    res.json({
      success: true,
      message: '‚úÖ Imagem enviada com sucesso!',
      image: uploadResult
    });

  } catch (error) {
    console.error('‚ùå Erro no upload de imagem:', error);
    res.status(500).json({
      success: false,
      message: 'Erro ao fazer upload da imagem: ' + error.message
    });
  }
});

// Listar artigos
app.get('/blog-adm/api/articles', requireAuth, async (req, res) => {
  try {
    if (!pgClient || !dbConnected) {
      return res.status(500).json({
        success: false,
        message: 'PostgreSQL desconectado. Reinicie o servidor.',
        articles: []
      });
    }

    const result = await pgClient.query(`
      SELECT id, titulo, categoria, autor, coautor, resumo, destaque, 
             imagem_principal, data_criacao, status, slug, created_at
      FROM public.blog_artigos 
      ORDER BY created_at DESC 
      LIMIT 50
    `);

    const articles = result.rows.map(row => ({
      id: row.id,
      titulo: row.titulo,
      categoria: row.categoria,
      autor: row.autor,
      coautor: row.coautor,
      resumo: row.resumo,
      destaque: row.destaque,
      imagem_principal: row.imagem_principal,
      data_criacao: row.data_criacao,
      status: row.status,
      slug: row.slug,
      created_at: row.created_at
    }));

    res.json({
      success: true,
      articles: articles,
      total: articles.length,
      ssl: 'disabled'
    });

  } catch (error) {
    console.error('‚ùå Erro ao listar artigos:', error);
    res.status(500).json({
      success: false,
      message: 'Erro ao carregar artigos: ' + error.message,
      articles: []
    });
  }
});

// Criar artigo - FUN√á√ÉO PRINCIPAL!
app.post('/blog-adm/api/articles', requireAuth, async (req, res) => {
  try {
    if (!pgClient || !dbConnected) {
      return res.status(500).json({
        success: false,
        message: '‚ùå ERRO: PostgreSQL desconectado! Reinicie o servidor.'
      });
    }

    const { titulo, categoria, autor, coautor, resumo, destaque, imagem_principal, content } = req.body;

    console.log('üìù CRIANDO ARTIGO NO POSTGRESQL:');
    console.log('===============================');
    console.log('üë§ Usu√°rio:', req.session.username);
    console.log('üìù T√≠tulo:', titulo ? titulo.substring(0, 50) + '...' : 'N/A');
    console.log('üìÇ Categoria:', categoria || 'N/A');
    console.log('üë®‚Äç‚öïÔ∏è Autor:', autor || 'N/A');
    console.log('üë• Co-autor:', coautor || 'N/A');
    console.log('‚≠ê Destaque:', destaque || false);
    console.log('üñºÔ∏è Imagem:', imagem_principal ? 'Sim' : 'N√£o');
    console.log('üìè Conte√∫do:', content ? content.length + ' chars' : '0');
    console.log('üîê SSL: DESABILITADO');
    console.log('===============================');

    // Valida√ß√£o
    const errors = [];
    if (!titulo || titulo.trim().length === 0) errors.push('T√≠tulo √© obrigat√≥rio');
    if (!categoria || categoria.trim().length === 0) errors.push('Categoria √© obrigat√≥ria');
    if (!autor || autor.trim().length === 0) errors.push('Autor √© obrigat√≥rio');
    if (!content || content.trim().length === 0) errors.push('Conte√∫do √© obrigat√≥rio');
    
    if (titulo && titulo.length > 255) errors.push('T√≠tulo muito longo');
    if (categoria && categoria.length > 100) errors.push('Categoria muito longa');
    if (autor && autor.length > 100) errors.push('Nome do autor muito longo');
    if (coautor && coautor.length > 100) errors.push('Nome do co-autor muito longo');
    if (resumo && resumo.length > 500) errors.push('Resumo muito longo');

    if (errors.length > 0) {
      console.log('‚ùå Valida√ß√£o falhou:', errors);
      return res.status(400).json({
        success: false,
        message: 'Dados inv√°lidos: ' + errors.join(', '),
        errors: errors
      });
    }

    // Gerar slug √∫nico
function generateSlug(text) {
  return text
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9\s-]/g, '')
    .trim()
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '');
}

    async function ensureUniqueSlug(baseSlug) {
      let slug = baseSlug;
      let counter = 1;
      
      while (true) {
        const existingSlug = await pgClient.query(
          'SELECT id FROM public.blog_artigos WHERE slug = $1',
          [slug]
        );
        
        if (existingSlug.rows.length === 0) {
          return slug;
        }
        
        counter++;
        slug = `${baseSlug}_${counter}`;
      }
    }

    const slug = generateSlug(titulo.trim());
    const finalSlug = await ensureUniqueSlug(slug);
    const now = new Date();

    console.log('üíæ Inserindo no PostgreSQL...');
    console.log('üîó Slug:', finalSlug);

    const insertQuery = `
      INSERT INTO public.blog_artigos 
      (titulo, slug, categoria, autor, coautor, resumo, destaque, imagem_principal, 
       data_criacao, data_atualizacao, content, status, created_at, updated_at)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14)
      RETURNING id, slug, titulo, categoria, autor, coautor, resumo, destaque, imagem_principal, created_at
    `;

    const values = [
      titulo.trim(),
      finalSlug,
      categoria.trim(),
      autor.trim(),
      coautor ? coautor.trim() : null,
      resumo ? resumo.trim() : null,
      destaque || false,
      imagem_principal || null,
      now.toISOString().split('T')[0],
      now.toISOString().split('T')[0],
      content.trim(),
      'publicado',
      now.toISOString(),
      now.toISOString()
    ];

    const result = await pgClient.query(insertQuery, values);
    const insertedArticle = result.rows[0];
    
    console.log('üéâ ARTIGO INSERIDO COM SUCESSO!');
    console.log('===============================');
    console.log('üÜî ID:', insertedArticle.id);
    console.log('üîó Slug:', insertedArticle.slug);
    console.log('üìù T√≠tulo:', insertedArticle.titulo);
    console.log('üìÇ Categoria:', insertedArticle.categoria);
    console.log('üë®‚Äç‚öïÔ∏è Autor:', insertedArticle.autor);
    console.log('üë• Co-autor:', insertedArticle.coautor || 'N/A');
    console.log('‚≠ê Destaque:', insertedArticle.destaque);
    console.log('üñºÔ∏è Imagem:', insertedArticle.imagem_principal || 'N/A');
    console.log('üìÖ Criado:', insertedArticle.created_at);
    console.log('üîê SSL: DESABILITADO');
    console.log('===============================');

    res.json({
      success: true,
      id: insertedArticle.id,
      slug: insertedArticle.slug,
      message: 'üéâ ARTIGO PUBLICADO COM SUCESSO!',
      mode: 'postgresql',
      ssl: 'disabled',
      timestamp: now.toISOString(),
      article: {
        id: insertedArticle.id,
        titulo: insertedArticle.titulo,
        categoria: insertedArticle.categoria,
        autor: insertedArticle.autor,
        coautor: insertedArticle.coautor,
        resumo: insertedArticle.resumo,
        destaque: insertedArticle.destaque,
        imagem_principal: insertedArticle.imagem_principal,
        slug: insertedArticle.slug
      }
    });
  } catch (error) {
    console.error('‚ùå ERRO AO CRIAR ARTIGO:', error.message);
    console.error('üîç Stack:', error.stack);
    
    res.status(500).json({
      success: false,
      message: 'ERRO ao publicar artigo: ' + error.message
    });
  }
});

// Rota principal
app.get('/blog-adm', (req, res) => {
  res.sendFile(path.join(__dirname, '../public/blog-adm/index.html'));
});

app.get('/blog-adm/', (req, res) => {
  res.sendFile(path.join(__dirname, '../public/blog-adm/index.html'));
});

app.get('/', (req, res) => {
  res.redirect('/blog-adm');
});

// Inicializar servidor
async function startServer() {
  try {
    console.log('üöÄ INICIANDO SERVIDOR SIMPLES (SEM SSL)...');
    console.log();
    
    // Conectar ao PostgreSQL
    const connected = await connectPostgreSQL();
    
    // Iniciar servidor
    app.listen(PORT, () => {
      console.log('‚úÖ Servidor web iniciado!');
      console.log(`üåê URL: http://localhost:${PORT}/blog-adm`);
      console.log(`üîê Login: ${ADMIN_CREDENTIALS.username} / ${ADMIN_CREDENTIALS.password}`);
      console.log();
      
      if (dbConnected) {
        console.log('üéâ STATUS: POSTGRESQL CONECTADO!');
        console.log(`üìç Endpoint: ${dbConfig.host}:${dbConfig.port}`);
        console.log('üîê SSL: DESABILITADO (conforme solicitado)');
        console.log('üíæ Artigos ser√£o salvos no banco!');
      } else {
        console.log('‚ùå STATUS: POSTGRESQL DESCONECTADO!');
        console.log('‚ö†Ô∏è Artigos N√ÉO ser√£o salvos!');
      }
      
      console.log();
      console.log('üìã Funcionalidades:');
      console.log('   ‚úÖ Sistema de autentica√ß√£o');
      console.log('   ‚úÖ Upload de imagens (Backblaze B2)');
      console.log('   ‚úÖ Interface web responsiva');
      console.log(`   ${dbConnected ? '‚úÖ' : '‚ùå'} Cria√ß√£o de artigos (PostgreSQL)`);
      console.log('   ‚úÖ SSL desabilitado');
      console.log();
    });
  } catch (error) {
    console.error('‚ùå Erro ao iniciar servidor:', error);
    process.exit(1);
  }
}

// Tratamento de erros
process.on('uncaughtException', (error) => {
  console.error('‚ùå Erro n√£o capturado:', error);
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('‚ùå Promise rejeitada:', reason);
  process.exit(1);
});

// Graceful shutdown
process.on('SIGINT', async () => {
  console.log('\nüîÑ Encerrando servidor...');
  
  if (pgClient) {
    await pgClient.end();
    console.log('‚úÖ Conex√£o PostgreSQL encerrada');
  }
  
  console.log('‚úÖ Servidor encerrado');
  process.exit(0);
});

// Iniciar aplica√ß√£o
startServer();
